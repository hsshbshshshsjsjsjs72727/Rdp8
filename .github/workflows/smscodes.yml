name: Rent Phone Number and Receive SMS Code

on:
  workflow_dispatch:

jobs:
  rent_and_receive_sms:
    runs-on: ubuntu-latest
    env:
      FIVE_SIM_API_KEY: ${{ secrets.FIVE_SIM_API_KEY }}
      COUNTRY: "US"
      PREFIX: "+1"
      FREE_TRIAL_CREDIT: "0.50"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Rent phone number from 5sim
        id: rent_number
        run: |
          echo "Renting phone number with free trial credit $FREE_TRIAL_CREDIT..."
          response=$(curl -s -X POST "https://5sim.net/v1/user/buy/activation/${COUNTRY}/any/any" \
            -H "Authorization: Bearer $FIVE_SIM_API_KEY")
          echo "Response: $response"
          phone_number=$(echo $response | jq -r '.phone')
          if [ "$phone_number" == "null" ] || [ -z "$phone_number" ]; then
            echo "Failed to rent phone number."
            exit 1
          fi
          echo "phone_number=$phone_number" >> $GITHUB_OUTPUT

      - name: Display rented phone number
        run: echo "Rented phone number: ${{ steps.rent_number.outputs.phone_number }}"

      - name: Wait for SMS code (up to 15 minutes)
        id: wait_sms
        run: |
          echo "Waiting for SMS code for phone number ${{ steps.rent_number.outputs.phone_number }}..."
          for i in {1..15}; do
            sms_response=$(curl -s -X GET "https://5sim.net/v1/user/check/${{ steps.rent_number.outputs.phone_number }}" \
              -H "Authorization: Bearer $FIVE_SIM_API_KEY")
            code=$(echo $sms_response | jq -r '.sms[0].code // empty')
            if [ -n "$code" ]; then
              echo "sms_code=$code" >> $GITHUB_OUTPUT
              echo "Received SMS code: $code"
              exit 0
            fi
            echo "No SMS yet. Waiting 1 minute... ($i/15)"
            sleep 60
          done
          echo "No SMS received in 15 minutes."
          exit 1

      - name: Use SMS code
        run: |
          echo "SMS code received: ${{ steps.wait_sms.outputs.sms_code }}"
          # Here you can add integration with ChatGPT or other steps using the SMS code

      - name: Complete job
        run: echo "Job completed successfully."
