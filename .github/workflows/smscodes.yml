name: Get ChatGPT SMS Code (5sim)

on:
  workflow_dispatch: # Allows manual trigger

jobs:
  get-phone-number:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get SMS from 5sim
        env:
          FIVESIM_API_KEY: ${{ secrets.FIVESIM_API_KEY }} # Set this in GitHub Secrets
        run: |
          # 1. Check Balance
          BALANCE_INFO=$(curl -s -H "Authorization: Bearer $FIVESIM_API_KEY" -H "Accept: application/json" https://5sim.net/v1/user/profile)
          BALANCE=$(echo $BALANCE_INFO | jq -r '.rating')
          echo "Current Balance Credit: $BALANCE"

          # 2. Purchase US Number for ChatGPT (OpenAI)
          # country: usa, operator: any, product: openai
          ORDER_RESPONSE=$(curl -s -H "Authorization: Bearer $FIVESIM_API_KEY" -H "Accept: application/json" "https://5sim.net/v1/user/buy/activation/usa/any/openai")
          
          ORDER_ID=$(echo $ORDER_RESPONSE | jq -r '.id')
          PHONE_NUMBER=$(echo $ORDER_RESPONSE | jq -r '.phone')

          if [ "$ORDER_ID" == "null" ] || [ -z "$ORDER_ID" ]; then
            echo "Error: Could not purchase number. Response: $ORDER_RESPONSE"
            exit 1
          fi

          echo "Successfully Purchased: $PHONE_NUMBER"
          echo "Order ID: $ORDER_ID"
          echo "Waiting for SMS code (Timeout: 15 minutes)..."

          # 3. Poll for SMS Code
          # Poll every 20 seconds for a maximum of 45 attempts (15 minutes)
          MAX_ATTEMPTS=45
          SLEEP_TIME=20
          CODE_FOUND=false

          for ((i=1; i<=MAX_ATTEMPTS; i++)); do
            CHECK_RESPONSE=$(curl -s -H "Authorization: Bearer $FIVESIM_API_KEY" -H "Accept: application/json" "https://5sim.net/v1/user/check/$ORDER_ID")
            SMS_DATA=$(echo $CHECK_RESPONSE | jq -r '.sms')

            # Check if sms array is not empty
            if [ "$SMS_DATA" != "null" ] && [ "$SMS_DATA" != "[]" ]; then
              SMS_CODE=$(echo $CHECK_RESPONSE | jq -r '.sms[0].code')
              echo "------------------------------------------"
              echo "SMS RECEIVED!"
              echo "Phone Number: $PHONE_NUMBER"
              echo "ChatGPT Code: $SMS_CODE"
              echo "------------------------------------------"
              CODE_FOUND=true
              break
            fi

            echo "Attempt $i/$MAX_ATTEMPTS: Still waiting for SMS..."
            sleep $SLEEP_TIME
          done

          if [ "$CODE_FOUND" = false ]; then
            echo "Timeout: No SMS received within 15 minutes."
            exit 1
          fi
