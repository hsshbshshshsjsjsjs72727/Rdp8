name: Rent Phone Number and Receive SMS Code

on:
  workflow_dispatch:

jobs:
  rent_and_receive_sms:
    runs-on: ubuntu-latest
    env:
      FIVESIM_API_KEY: ${{ secrets.FIVESIM_API_KEY }}
      COUNTRY: US
      AREA_CODE: 650
      PREFIX: +1
      WAIT_TIME_MINUTES: 15

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Rent phone number from 5sim
      id: rent_number
      run: |
        echo "Renting phone number with area code $AREA_CODE in $COUNTRY"
        response=$(curl -s -H "Authorization: Bearer $FIVESIM_API_KEY" \
          "https://5sim.net/v1/user/buy/activation/$COUNTRY/any/any?operator=any&area=$AREA_CODE")
        echo "Response: $response"
        number=$(echo $response | jq -r '.phone')
        id=$(echo $response | jq -r '.id')
        echo "Rented number: $number"
        echo "::set-output name=number::$number"
        echo "::set-output name=id::$id"

    - name: Wait for SMS code (up to 15 minutes)
      id: wait_sms
      run: |
        id=${{ steps.rent_number.outputs.id }}
        echo "Waiting for SMS for activation id $id"
        for i in $(seq 1 $((WAIT_TIME_MINUTES * 6))); do
          sms_response=$(curl -s -H "Authorization: Bearer $FIVESIM_API_KEY" "https://5sim.net/v1/user/check/$id")
          sms_code=$(echo $sms_response | jq -r '.sms[0].code // empty')
          if [ -n "$sms_code" ]; then
            echo "Received SMS code: $sms_code"
            echo "::set-output name=code::$sms_code"
            exit 0
          fi
          echo "No SMS yet, retrying in 10 seconds..."
          sleep 10
        done
        echo "Timeout reached without receiving SMS"
        exit 1

    - name: Output results
      if: success()
      run: |
        echo "Phone number rented: ${{ steps.rent_number.outputs.number }}"
        echo "SMS code received: ${{ steps.wait_sms.outputs.code }}"

    - name: Handle failure
      if: failure()
      run: echo "Failed to receive SMS code within 15 minutes."
